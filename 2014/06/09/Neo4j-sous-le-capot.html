<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Neo4j sous le capot</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="//fbiville.github.io/themes/Casper/favicon.ico">

    <link rel="stylesheet" type="text/css" href="//fbiville.github.io/themes/Casper/assets/css/screen.css?v=1.0.0" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />

    <link rel="canonical" href="https://fbiville.github.io/2014/06/09/Neo4j-sous-le-capot.html" />
    
    <meta property="og:site_name" content="(10 piece) Puzzler" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Neo4j sous le capot" />
    <meta property="og:description" content="3615-ma-vie Tout ce qui va suivre n’est qu’un tissu de mauvaises excuses, me direz-vous, mais j’ai tout de même quelques circonstances atténuantes quant à l’inactivité de mon blog (et mon absence de la scène parisienne : je..." />
    <meta property="og:url" content="https://fbiville.github.io/2014/06/09/Neo4j-sous-le-capot.html" />
    <meta property="article:published_time" content="2014-06-08T22:00:00.000Z" />
    <meta property="article:modified_time" content="2015-05-09T12:01:38.299Z" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Neo4j sous le capot" />
    <meta name="twitter:description" content="3615-ma-vie Tout ce qui va suivre n’est qu’un tissu de mauvaises excuses, me direz-vous, mais j’ai tout de même quelques circonstances atténuantes quant à l’inactivité de mon blog (et mon absence de la scène parisienne : je..." />
    <meta name="twitter:url" content="https://fbiville.github.io/2014/06/09/Neo4j-sous-le-capot.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "(10 piece) Puzzler",
    "author": {
        "@type": "Person",
        "name": "@fbiville",
        "image": "https://avatars.githubusercontent.com/u/445792?v=3",
        "url": "undefined/author/undefined",
        "sameAs": "http://florent.biville.net"
    },
    "headline": "Neo4j sous le capot",
    "url": "https://fbiville.github.io/2014/06/09/Neo4j-sous-le-capot.html",
    "datePublished": "2014-06-08T22:00:00.000Z",
    "dateModified": "2015-05-09T12:01:38.299Z",
    "description": "3615-ma-vie Tout ce qui va suivre n’est qu’un tissu de mauvaises excuses, me direz-vous, mais j’ai tout de même quelques circonstances atténuantes quant à l’inactivité de mon blog (et mon absence de la scène parisienne : je..."
}
    </script>

    <meta name="generator" content="Ghost ?" />
    <link rel="alternate" type="application/rss+xml" title="(10 piece) Puzzler" href="https://fbiville.github.io/rss" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
</head>
<body class="post-template">

    


<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        <a class="back-button icon-arrow-left" href="https://fbiville.github.io">Home</a>
        <!-- <a class="subscribe-button icon-feed" href="https://fbiville.github.io/rss/">Subscribe</a> -->
    </nav>
</header>

<main class="content" role="main">

    <article class="post">

        <header class="post-header">
            <h1 class="post-title">Neo4j sous le capot</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2014-06-09">09 June 2014</time> 
            </section>
        </header>

        <section class="post-content">
            <div class="sect1">
<h2 id="_3615_ma_vie">3615-ma-vie</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Tout ce qui va suivre n’est qu’un tissu de mauvaises excuses, me
direz-vous, mais j’ai tout de même quelques circonstances atténuantes
quant à l’inactivité de mon blog (et mon absence de la scène parisienne
: je n’y ai pas fait de talks depuis 6 mois).</p>
</div>
<div class="paragraph">
<p>Sur un plan personnel d’abord, je suis heureux de vous annoncer qu’une
jolie alliance orne désormais l’annulaire de ma main gauche :-)</p>
</div>
<div class="paragraph">
<p>Sur un plan professionnel, bien qu’absent “publiquement”, beaucoup de
choses se sont passées : ma première
<a href="http://www.lateral-thoughts.com/formation-neo4j">formation sur Neo4j</a> a
eu lieu, j’ai eu l’occasion d’intervenir chez plus de clients et
certains projets autour de Neo4j s’esquissent encore (stay tuned!).</p>
</div>
<div class="paragraph">
<p>D’ailleurs, si vous voulez que je vienne parler de Neo4j dans votre User
Group, n’hésitez pas à me contacter (sur
<a href="https://twitter.com/fbiville">Twitter</a> par exemple).</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_back_to_business_parlons_de_neo">Back to business : parlons de Neo</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_base_de_donn_es_orient_e_graphe">Base de données orientée graphe ?</h3>
<div class="paragraph">
<p><a href="http://www.neo4j.org/">Neo4j</a>, vous l’aurez compris, est une base de
données orientée graphe. Mais qu’est-ce qu’”orientée graphe” signifie
exactement ?</p>
</div>
<div class="paragraph">
<p>Si l’on cite
<a href="http://fr.wikipedia.org/wiki/Base_de_donn%C3%A9es_orient%C3%A9e_graphe">Wikipedia</a>,
une base de données orientée graphe (<em>graph database</em>) est donc une
base de données mettant en oeuvre des noeuds, relations et propriétés
pour représenter et stocker de la donnée.</p>
</div>
<div class="paragraph">
<p>Cette définition peut vous paraître anodine, mais notez bien la présence
de deux verbes (et non pas d’un seul) :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>représenter</p>
</li>
<li>
<p>stocker</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>En termes plus techniques, une base de données orientée graphe offre
donc une API (“représenter”) exposant un vocabulaire propre au graphe.
Ses enregistrements sur disque (“stocker”) doivent eux aussi être
formatés selon les structures d’un graphe.</p>
</div>
<div class="paragraph">
<p>Ce deuxième point est fondamental.</p>
</div>
<div class="paragraph">
<p>Prenons l’exemple d’un concurrent de Neo4j :
<a href="http://thinkaurelius.github.io/titan/">Titan</a>.</p>
</div>
<div class="paragraph">
<p>Dès la page d’accueil, on peut lire :</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>Titan is a scalable graph database [&#8230;&#8203;]</p>
</div>
<div class="paragraph">
<p>Support for various storage backends:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Apache Cassandra</p>
</li>
<li>
<p>Apache HBase</p>
</li>
<li>
<p>Oracle BerkeleyDB</p>
</li>
<li>
<p>Akiban Persistit</p>
</li>
</ul>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Cela contredit la définition que je vous ai donnée plus haut.</p>
</div>
<div class="paragraph">
<p>Si Titan était une base de données graphe, cela impliquerait que
Cassandra, HBase, BerkeleyDB et Persistit le soient. Or, jusqu’à preuve
du contraire, cela n’est pas le cas :)</p>
</div>
<div class="paragraph">
<p>Titan propose une <strong>surcouche</strong> d&#8217;API orientée graphe, déléguant la
persistance à des stores distribuées. Cela n’en fait pas pour autant une
base de données orientée graphe, tout comme
<a href="https://giraph.apache.org/">Apache Giraph</a> n’est “qu’une” API de calcul
orientée graphe.</p>
</div>
<div class="paragraph">
<p>“Quelle importance ?”, me direz-vous ?</p>
</div>
<div class="paragraph">
<p>Hé bien, une base de données graphe, bien qu’elle offre des nombreux
avantages, est intrinsèquement difficile à distribuer comme nous allons
le voir au travers de cet article. C’est en regardant les couches les
plus basses d’une base typiquement orientée graphe comme Neo4j que vous
allez comprendre ce qu’être une base de données graphe implique en
termes de partis pris.</p>
</div>
</div>
<div class="sect2">
<h3 id="_des_liens_et_des_cha_nes">Des liens et des chaînes</h3>
<div class="paragraph">
<p>Neo4j, selon le modèle du
<a href="https://github.com/tinkerpop/blueprints/wiki/Property-Graph-Model">Property
Graph</a>, structure les données par des noeuds liés par des relations.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Chacune de ces entités peut se voir attribuer un ensemble de
propriétés (une clef [String], une valeur [entier, String, tableau de
primitifs]).</p>
</li>
<li>
<p>Chaque relation porte obligatoirement une notion de type (exemple :
une relation “FOLLOWS” ou “IS_FRIEND_WITH”).</p>
</li>
<li>
<p>Chaque noeud porte, depuis la version 2.0, une notion optionnelle
(mais fortement recommandée) appelée “label” (un noeud a de 0 à n
labels).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Évidemment, toutes ces informations sont persistées sur disque.</p>
</div>
<div class="paragraph">
<p>Un simple <code>\`ls /path/to/neo/data/graph.db\`</code> vous permettra de
constater, outre les fichiers d’indexes Lucene (legacy: répertoire
“<code>index</code>”, nouveau: répertoire “<code>schema</code>”) et les journaux de
transactions, les différents fichiers .db :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>neostore.labeltokenstore.db</p>
</li>
<li>
<p>neostore.nodestore.db</p>
</li>
<li>
<p>neostore.propertystore.db</p>
</li>
<li>
<p>neostore.relationshipstore.db</p>
</li>
<li>
<p>neostore.schemastore.db</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ils représentent tous un “store” dédié à un type de données particulier.
Passons-les en revue individuellement, en commençant par les
nouveautés.</p>
</div>
<div class="paragraph">
<p>Notez que les informations à venir sont sujettes à caution : les
<a href="http://neo4j.com/blog/the-neo4j-2-1-0-milestone-1-release-import-and-dense-nodes/">récents
travaux</a> autour des noeuds denses ont sans doute influencé le format des
fichiers décrits.</p>
</div>
<div class="sect3">
<h4 id="_labeltokenstore">LabelTokenStore</h4>
<div class="paragraph">
<p>On s’en douterait presque, ce(s) fichier(s) contien(nen)t les
enregistrements de labels. Il(s) n’existai(en)t donc pas avant la sortie
de la 2.0.</p>
</div>
<div class="paragraph">
<p>Ces enregistrements comprennent :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un ID interne (typé int en Java, donc jusqu’à 2³¹ - 1 [sauf Java 8 où
on peut avoir des int de 0 à 232 - 1 mais je diverge]). chacun de ces
IDs est référencé dans le fichier neostore.labeltokenstore.db.id.</p>
</li>
<li>
<p>et un nom (c’est justement la valeur que vous assignez au label :
“Personne” pour le label Personne) lui-même uniquement identifié
(neostore.labeltokenstore.db.names.id) et stocké dans
(neostore.labeltokenstore.db.names)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ainsi le fichier neostore.labeltokenstore.db ne comporte en fait que des
références vers les IDs internes et noms, stockés “à côté”. Notez que
cette division en fichier neostore.<strong>.db.</strong>* se retrouve pour tous les
autres stores.</p>
</div>
</div>
<div class="sect3">
<h4 id="_schemastore">SchemaStore</h4>
<div class="paragraph">
<p>Avec l’émergence des labels est apparu la notion de schema. Ne vous
emballez pas : Neo4j n’est pas devenue une base de données normalisée.
On parle plutôt d’une base de données <em>schema-optional</em>.</p>
</div>
<div class="paragraph">
<p>Les labels permettent de grouper des noeuds sémantiquement similaires
(cela est donc complètement dépendant du domaine métier) mais rien
n’empêche lesdits noeuds d’être complètement hétérogènes. Par exemple,
deux noeuds peuvent partager le label Personne tout en comportant des
propriétés différentes, disons, la couleur des cheveux pour l’un, la
pointure pour l’autre.</p>
</div>
<div class="paragraph">
<p>Maintenant que nous avons des labels à disposition, nous pouvons même
définir des contraintes sur ceux-ci : des contraintes d’unicité par
exemple. Ces contraintes sont en fait appelées <em>rules</em> et l’ensemble de
celles-ci forment le fameux schema dont je vous parlais. Ce support est
assez récent et la structuration sous-jacente est encore toute simple.
En effet, une rule comprend :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un ID interne (<code>neostore.schemastore.db.id</code>)</p>
</li>
<li>
<p>sa description à proprement parler (<code>neostore.schemastore.db</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Jusqu’ici, j’ai couvert les additions récentes de Neo4j.</p>
</div>
<div class="paragraph">
<p>Bien entendu, Neo n’a pas attendu sa version 2.0 pour être une base de
données orientée graphe à part entière. Regardons ses composants
centraux.</p>
</div>
</div>
<div class="sect3">
<h4 id="_propertystore">PropertyStore</h4>
<div class="paragraph">
<p>À quoi servirait une base de données orientée graphe sans propriétés sur
nos noeuds et relations ? Pas grand chose :-)</p>
</div>
<div class="paragraph">
<p>Ces propriétés (rappel : propriété = clef/valeur) néanmoins ne sont pas
enregistrées exactement au même endroit selon certains critères :</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>neostore.propertystore.db.index</code> stocke la partie “clef” des
propriétés</p>
</li>
<li>
<p><code>neostore.propertystore.db.arrays</code>, comme son nom l’indique, est dédié
aux propriétés dont la valeur est un tableau de primitives ou String</p>
</li>
<li>
<p><code>neostore.propertystore.db.strings</code> quant à lui se charge de
répertorier les propriétés dont la valeur est une chaîne de caractères</p>
</li>
<li>
<p>les autres propriétés (booléen, entier) sont stockés directement dans
<code>neostore.propertystore.db</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Chaque jeu de propriétés est propre à la relation/le noeud le contenant,
les propriétés sont représentées comme des listes simplement chaînées.</p>
</div>
</div>
<div class="sect3">
<h4 id="_nodestore_et_relationshipstore">NodeStore et RelationshipStore</h4>
<div class="paragraph">
<p>Le voilà, le nerf de la guerre !</p>
</div>
<div class="paragraph">
<p>Commençons par les noeuds. Chaque noeud est composé d’un :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ID “interne” (<code>neostore.nodestore.db.id</code>)</p>
</li>
<li>
<p>des références à ses labels (<code>neostore.nodestore.db.labels{,.id}</code>)</p>
</li>
<li>
<p>une référence vers sa première propriété (l’ID interne de la
propriété) et le premier noeud parmi tous ceux qui lui sont liés (le
tout dans <code>neostore.nodestore.db</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Conceptuellement, cela pourrait se représenter ainsi (slide
outrageusement et à de nombreuses reprises emprunté à Neo Technology) :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/graph_on_disk.png" alt="graph on disk.png">
</div>
</div>
<div class="paragraph">
<p>Tout repose sur la structuration des enregistrements de relations. Cela
est plutôt intuitif : les relations sont l’épine dorsale du graphe.</p>
</div>
<div class="paragraph">
<p>Cet élément central se décompose de la façon suivante :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>un ID “interne” (comme d’hab’ : <code>neostore.relationshipstore.db.id</code>)</p>
</li>
<li>
<p>son type (<code>neostore.relationshiptypestore.db.names</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Pour l’instant, ça n’explique pas ce qui en fait une base orientée
graphe.</p>
</div>
<div class="paragraph">
<p>Pour cela, regardons plutôt le code Java (eh oui, c’est ça qui est cool
avec les <a href="https://github.com/neo4j/neo4j">projets open source</a> dans les
langages qu’on connaît bien) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class RelationshipRecord extends PrimitiveRecord

{

    private long firstNode;

    private long secondNode;

    private int type;

    private long firstPrevRel = 1;

    private long firstNextRel = Record.NO_NEXT_RELATIONSHIP.intValue();

    private long secondPrevRel = 1;

    private long secondNextRel = Record.NO_NEXT_RELATIONSHIP.intValue();

    // [...]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Passons sur le formatage digne des codeurs C les plus chevronnés (qui
pour une Pull Request pour remettre les accolades en fin de ligne ? :P).</p>
</div>
<div class="paragraph">
<p>Ce qui est vraiment intéressant ici, c’est cette notion de <code>first</code> et
<code>second</code>. En réalité, il s’agit des références internes (tout est
référence à ce niveau) aux enregistrements correspondant aux noeuds de
départ et d’arrivée. Seulement, la notion de direction n’ayant de sens
qu’au moment du requêtage et non à la création de la relation, on ne
peut pas savoir, à ce niveau, qui du <code>first</code> ou du <code>second</code> est le noeud
de départ d’où cette nomenclature.</p>
</div>
<div class="paragraph">
<p>Ce que vous devez comprendre de ce petit bout de code, c’est qu’une
relation porte en réalité, outre les informations précédemment
mentionnées :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>une référence vers ses noeuds de départ et d’arrivée</p>
</li>
<li>
<p>une référence vers la précédente relation des noeuds de départ /
d’arrivée</p>
</li>
<li>
<p>une référence vers la relation suivante des noeuds de départ /
d’arrivée</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Une illustration vaut mieux qu’un long discours :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/graph_on_disk_bis.png" alt="graph on disk bis.png">
</div>
</div>
<div class="paragraph">
<p>Il s’agit exactement de ce que j’ai tenté d’expliquer : les flèches
rouges symbolisent les liens portés par les enregistrements de
relations. Chacune de ces relations pointe vers les relations
précédentes/suivantes de ses noeuds de départ et d’arrivée.</p>
</div>
<div class="paragraph">
<p>Autrement dit, chaque noeud référence (flèche verte) un élément d’une
liste doublement chaînée de relations.</p>
</div>
<div class="paragraph">
<p>Et c’est là la nature même du graphe !</p>
</div>
<div class="paragraph">
<p>C’est par cette structure que Neo4j peut se targuer d’être une base de
données graphe.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Comment requêter de la donnée dans un graphe ? Par une traversée.</p>
</li>
<li>
<p>Comment traverser dans Neo4j ? En trouvant les points de départ les
plus pertinents possible et en naviguant dans listes de
relations/noeuds.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vous commencez à comprendre pourquoi ce genre de base de données
s’adapte très bien aux données fortement connectées ?</p>
</div>
</div>
<div class="sect3">
<h4 id="_quid_des_noeuds_denses">Quid des noeuds denses ?</h4>
<div class="paragraph">
<p>Ahah, je vois que j’ai affaire à des lecteurs initiés ;)</p>
</div>
<div class="paragraph">
<p>Resituons le contexte au travers de deux situations légèrement
différentes.</p>
</div>
<div class="sect4">
<h5 id="_situation_n_1">Situation n°1</h5>
<div class="paragraph">
<p>Un noeud dense est un noeud qui est fortement connecté. De nombreux
exemples se retrouvent d’ailleurs dans la vie courante. Par exemple,
Justin Bieber a 52 millions de followers sur Twitter (tiens, je ne
savais pas que la surdité était devenu un phénomène de masse).</p>
</div>
<div class="paragraph">
<p>Rappelez-vous, le noeud Justin Bieber pointe vers sa première relation.
Si par manque de chance, vous avez besoin d’accéder à son 52 millionième
noeud-fan, vous allez devoir traverser, dans le pire des cas,
l’intégralité de la liste doublement chaînée des relations avant de le
retrouver : bref, du O(n)&#8230;&#8203; vraiment pas terrible.</p>
</div>
<div class="paragraph">
<p>Ceci dit, ce cas reste relativement rare. Modifions légèrement
l’exemple.</p>
</div>
</div>
<div class="sect4">
<h5 id="_situation_n_2">Situation n°2</h5>
<div class="paragraph">
<p>Justin Bieber a certes 52 millions de followers mais il a bien moins de
personnes dans sa famille.</p>
</div>
<div class="paragraph">
<p>Si par hasard, parmi cette gigantesque quantité de relations, seules les
relations familiales vous intéressent, vous faites face exactement au
même problème que décrit ci-dessus… si vous utilisez une version de
Neo4j antérieure à la version 2.1 de Neo4j.</p>
</div>
<div class="paragraph">
<p>Depuis cette version, les relations sont aussi discriminées par type,
permettant ainsi de ne pas tomber dans cet écueuil. Un noeud est
d’ailleurs considéré dense à partir de 50 relations par défaut (cf.
“http://docs.neo4j.org/chunked/stable/kernel-configuration.html[dense
node threshold]”).</p>
</div>
</div>
<div class="sect4">
<h5 id="_help_je_suis_dans_la_situation_n_1">Help! Je suis dans la situation n°1!</h5>
<div class="paragraph">
<p>Si par malheur, et après exploration de toutes les alternatives
(échantillonnage statistique etc), vous en concluez que vous ne pouvez
faire autrement : rassurez-vous !</p>
</div>
<div class="paragraph">
<p>Tout d’abord, les équipes de Neo continuent de plancher et d’apporter
des améliorations à ce sujet. Nous devrions donc voir quelques
améliorations avec la v2.2.</p>
</div>
<div class="paragraph">
<p>De plus, une approche simple <a href="https://github.com/maxdemarzi/dense">est
déjà codée pour vous</a> par l’excellent
<a href="https://twitter.com/maxdemarzi">Max</a> <a href="http://maxdemarzi.com/">de</a>
<a href="https://www.kickstarter.com/projects/1355751798/high-performance-neo4j-video-course">Marzi</a>.</p>
</div>
<div class="paragraph">
<p>L’idée de son extension est simple : elle va simplement ventiler les
noeuds par niveau lors de chaque nouvelle insertion et les lire de façon
transparente.</p>
</div>
<div class="paragraph">
<p>Voici donc un exemple de structure automatiquement créée par son
extension :</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/dense_nodes.png" alt="dense nodes.png">
</div>
</div>
<div class="paragraph">
<p>Tout comme Justin Bieber, Lady Gaga et Madonna ont également de nombreux
fans (chaque fan “LIKES” l’artiste).
Un noeud factice va donc se substituer aux noeuds que l’on aurait
directement lié aux artistes et introduire des couches, par le biais de
noeuds intermédiaires regroupant eux aussi un nombre limité de fans,
relié alors par une “DENSE_LIKES”.
Les relations sont maintenant réparties et l’on pourra paginer nos
requêtes de lecture de cette façon :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cypher" data-lang="cypher">MATCH (fan:Fan)-[:DENSE_LIKES*0..5]-&gt;()-[:LIKES]-&gt;(loved:Artist \{name:
“Madonna”})
RETURN fan</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cette requête signifie (en lisant le pattern de bas en haut, de droite à
gauche) :</p>
</div>
<div class="listingblock">
<div class="content">
<pre>retourne tous les noeuds au label “Artist” et au nom “Madonna” +
qui sont “LIKÉS“ par un noeud quelconque (appelons-le META) +
et 0 à 5 relations DENSE_LIKE séparent META des noeuds</pre>
</div>
</div>
<div class="paragraph">
<p>Étant donné que la requête recherche les nombreux fans d’un artiste,
sans aucune ventilation du graphe, nous serions en plein dans la
situation n°1 décrite préalablement. Néanmoins, cette approche simple
couplée à l’usage astucieux des
<a href="http://docs.neo4j.org/chunked/milestone/query-match.html#match-variable-length-relationships">variable-length
paths</a> permet de ne récupérer qu’une fraction des fans sans pour autant
traverser toutes les relations dont l’artiste dépend.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_neo4j_et_scalabilit">Neo4j et scalabilité</h3>
<div class="paragraph">
<p>Maintenant que le format physique des fichiers est un peu plus clair,
regardons un peu les couches supérieures.</p>
</div>
<div class="sect3">
<h4 id="_architecture">Architecture</h4>
<div class="paragraph">
<p>Les accès disques sont bien évidemment limités autant que possible. Deux
niveaux de cache interviennent.</p>
</div>
<div class="sect4">
<h5 id="_le_em_file_buffer_cache_em">Le <em>file buffer cache</em></h5>
<div class="paragraph">
<p>Vous vous en doutez, le file buffer cache sert de tampon aux
écritures/lectures des enregistrements physiques (cf. les fichiers
décrits précédemment). Les entrées les moins récemment accédées sont
évincées du buffer
(<a href="http://en.wikipedia.org/wiki/Least_Recently_Used#LRU">LRU</a>).
Si possible, ce buffer est directement mappé au fichier store
sous-jacent (“memory-mapping”). Ce comportement dépend du système de
fichiers et de l’OS.
Quoi qu’il en soit, cette couche a pour seul but de réduire au maximum
les accès disque mais n’introduit aucune forme d’abstraction sur les
données manipulées.</p>
</div>
</div>
<div class="sect4">
<h5 id="_l_em_object_cache_em">L’<em>object cache</em></h5>
<div class="paragraph">
<p>Lui aussi cache LRU, c’est à partir de ce moment-là que les données
manipulées commencent à prendre la forme du graphe que vous requêtez par
traversée ou par Cypher. Notez que l’allocation mémoire à ce niveau est
prise sur la heap de la JVM hôte et non plus directement de l’OS hôte
sous-jacent.
C’est pourquoi il est souvent préférable de déployer Neo4j de façon
isolée, afin que votre application ne vienne pas perturber (comme par
exemple : ) les cycles GC de votre instance Neo et vise-versa.</p>
</div>
</div>
<div class="sect4">
<h5 id="_et_le_reste">et le reste</h5>
<div class="paragraph">
<p>À partir de là, les APIs unitaires Java prennent le relais, suivies des
APIs de traversées, Cypher et les APIs REST !</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/neo4j_archi.png" alt="neo4j archi.png">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_gestion_de_la_concurrence">Gestion de la concurrence</h4>
<div class="paragraph">
<p>Bien que faisant partie de cette (non-)famille qu’est NoSQL, Neo4j fait
un peu figure d’exception, en se conformant à ACID. En effet, vous
retrouverez avec Neo4j les transactions en 2 phases que vous connaissez
bien.
N’étant pas un spécialiste des systèmes distribués, je vous invite à
lire la multitude d’articles existants sur les limites d’ACID, les
limites du locking et les alternatives existantes (“lock-free
concurrency”, BASE vs ACID) : Google est votre ami.
J’en profite donc pour passer à la partie qui m’intéresse le plus : le
<em>sharding</em> :)</p>
</div>
</div>
<div class="sect3">
<h4 id="__em_sharding_em_d_un_graphe_dynamique"><em>Sharding</em> d’un graphe dynamique</h4>
<div class="paragraph">
<p>Expliquons brièvement le terme <em>sharding</em>. Le <em>sharding</em> consiste
simplement à répartir ses données entre différentes instances d’un
système de persistence distribué. Par exemple : je peux décider de
stocker toutes les adresses postales américaines sur mes serveurs aux
États-Unis et mes adresses australiennes à Sydney.
Une instance donnée ne contient donc pas l’intégralité des données, mais
le domaine métier auquel appartient mon application appartient comporte
des notions qui se répartissent naturellement. Eh oui ! Le <em>sharding</em>
est une solution technique, certes, mais hautement dépendante du métier
(comme toute solution technique devrait l’être, mais je digresse).</p>
</div>
<div class="sect4">
<h5 id="_graphe_statique">Graphe statique</h5>
<div class="paragraph">
<p>Un graphe statique est plutôt facile à <em>sharder</em> (dans la mesure où le
domaine métier modélisé le permet), ses fragmentations sont faciles à
détecter (on parle de “<em>graph clustering</em>” ou de “<em>community
detection</em>”) : elles ne sont pas amenées à évoluer du tout.
<a href="http://en.wikipedia.org/wiki/Strongly_connected_component">Certains
algorithmes</a> sont même relativement faciles à implémenter.</p>
</div>
</div>
<div class="sect4">
<h5 id="_graphe_dynamique">Graphe dynamique</h5>
<div class="paragraph">
<p>Pour les graphes dynamiques, en revanche, c’est une autre paire de
manche. De nombreuses opérations d’insertion et suppression
interviennent en permanence et elles impactent nécessairement la
topologie du graphe.
Le but du jeu est donc de déterminer un découpage du graphe en shards de
telle sorte, qu’à tout instant, le nombre de relations inter-shards soit
minimisé. Cela est d’autant plus critique que les shards sont distants
(imaginez la latence réseau induite par une traversée qui commence par
un shard hébergé à Los Angeles pour finir dans un shard à Pékin).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/images/neo4j_shards.png" alt="neo4j shards.png">
</div>
</div>
<div class="paragraph">
<p>C’est un
<a href="http://alexaverbuch.blogspot.fr/2010/04/me-my-names-alex-im-currently.html">sujet
de recherche</a> à part entière et Neo Technology travaille depuis
plusieurs années sur un système shardable.
Comprenez bien le terrible dilemne : par son orientation graphe dès les
couches physiques, Neo4j est à la fois idéal pour stocker et requêter
des données sous forme de graphe mais également très difficile à sharder
!</p>
</div>
</div>
<div class="sect4">
<h5 id="_une_lueur_d_espoir">Une lueur d’espoir ?</h5>
<div class="paragraph">
<p>Il est pour l’instant nécessaire de miser sur du
<a href="http://fr.wikipedia.org/wiki/Scalability"><em>scaling vertical</em></a> :
dimensionnez suffisamment vos machines et tout se passera très bien.
Laissez-moi vous rassurer davantage :
* jusqu’à présent, une infime minorité de clients a été confrontée à une
volumétrie telle
(<a href="http://docs.neo4j.org/chunked/stable/capabilities-capacity.html">capacité
nomimale de Neo4j</a> : 34 millards de noeuds et de relations) qu’une
répartition des données était nécessaire
* il se trouve que certains domaines métiers permettent naturellement de
ségréguer ses données
* il existe un début de solution de répartition !</p>
</div>
</div>
<div class="sect4">
<h5 id="_le_em_cache_sharding_em">Le <em>cache sharding</em> !</h5>
<div class="paragraph">
<p>Le titre peut faire peur, mais rassurez-vous, l’idée est toute simple.
Tout d’abord, cette idée s’applique à Neo4j en mode
<a href="http://docs.neo4j.org/chunked/stable/ha-how.html">High Availability</a>. En
d’autres termes, cela ne s’applique qu'à une instance Neo4j au sein
d&#8217;un <em>cluster</em>.</p>
</div>
<div class="paragraph">
<p>Non seulement vous bénéficiez d’une réplication master/replica, mais
vous pouvez également bénéficier de <em>sharding</em>.
Oui, oui, j’ai bien dit <em>sharding</em>.
Malheureusement, pour les raisons évoquées plus haut, il ne s&#8217;agit pas
de <em>sharding</em> sur les données à proprement parler. Comme le titre
l’évoque, il s’agit de sharding sur le cache.</p>
</div>
<div class="paragraph">
<p>Comment est-ce possible ? C’est tout simple !</p>
</div>
<div class="paragraph">
<p>Les caches de Neo4j sont des caches LRU, ils ne conservent que les
entrées les plus récentes en leur sein. S’il existait un moyen de
répartir les requêtes de façon persistante entre chaque instance de mon
cluster, le tour serait joué. En effet, la requête X serait toujours
exécutée sur l’instance A, la requête Y sur l’instance B… Le résultat X
serait de facto dans les caches A, celui d’Y dans les caches B. Mes
données seraient donc effectivement réparties par cache.
Le problème se réduit donc à : comment répartir de façon consistante les
requêtes à exécuter entre les instances de mon cluster Neo4j ?
Je vous le donne en mille. La solution existe depuis des lustres : un
simple load balancer comme <a href="http://haproxy.1wt.eu/">HAProxy</a> saura faire
l’affaire. On parle de consistent routing (plus généralement de
<a href="http://en.wikipedia.org/wiki/Consistent_hashing"><em>consistent hashing</em></a>).
Il suffit de configurer sa façon de router selon un des arguments
présents dans le corps ou un quelconque entête des appels HTTP envoyés à
Neo (rappelez-vous : toute communication distante est définie par une
API REST) et le load balancer se chargera d’exécuter vos ordres là où
vous l’avez configuré !
Astucieux, non ?
Un simple load balancer, un cluster Neo4j (l’édition High Availability
vous fournit tous les outils qu’il vous fait) et vous êtes prêts à
affronter une forte volumétrie de données !</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Une des leçons de NOSQL est que toute solution se restreint à un certain
champ d’application et s’applique sous certaines conditions. J’espère
que cet article vous aura permis de comprendre les faiblesses mais
surtout les forces des bases de données graphe et, qui sait, vous
donnera envie d’approfondir le sujet.</p>
</div>
<div class="paragraph">
<p>Je ne prétends pas à l’exhaustivité, donc si vous souhaitez que je
détaille d’autres parties (exemple : Cypher), je peux éventuellement y
consacrer d’autres articles.</p>
</div>
<div class="paragraph">
<p><code>&lt;shameless_plug&gt;`Si cet article vous a plu, je peux aussi venir en
parler dans un User Group de votre ville et je donne des
<a href="http://www.lateral-thoughts.com/formation-neo4j">formations customisables
sur Neo4j</a> et en français !</code>&lt;/shameless_plug&gt;`</p>
</div>
</div>
</div>
        </section>

        <footer class="post-footer">


            <figure class="author-image">
                <a class="img" href="" style="background-image: url(https://avatars.githubusercontent.com/u/445792?v=3)"><span class="hidden">@fbiville's Picture</span></a>
            </figure>

            <section class="author">
                <h4><a href="">@fbiville</a></h4>

                    <p>Read <a href="">more posts</a> by this author.</p>
                <div class="author-meta">
                    <span class="author-location icon-location">Paris, France</span>
                    <span class="author-link icon-link"><a href="http://florent.biville.net">http://florent.biville.net</a></span>
                </div>
            </section>


            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://twitter.com/share?text=Neo4j%20sous%20le%20capot&amp;url=https://fbiville.github.io/2014/06/09/Neo4j-sous-le-capot.html"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://fbiville.github.io/2014/06/09/Neo4j-sous-le-capot.html"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=https://fbiville.github.io/2014/06/09/Neo4j-sous-le-capot.html"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

        </footer>


        <section class="post-comments">
          <div id="disqus_thread"></div>
          <script type="text/javascript">
          var disqus_shortname = 'fbiville-github-io'; // required: replace example with your forum shortname
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </section>


    </article>

</main>



    <footer class="site-footer clearfix">
        <section class="copyright"><a href="https://fbiville.github.io">(10 piece) Puzzler</a> &copy; 2015</section>
        <section class="poweredby">Proudly published with <a href="http://hubpress.io">HubPress</a></section>
    </footer>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();      
      </script>

    <script type="text/javascript" src="//fbiville.github.io/themes/Casper/assets/js/jquery.fitvids.js?v=1.0.0"></script>
    <script type="text/javascript" src="//fbiville.github.io/themes/Casper/assets/js/index.js?v=1.0.0"></script>

</body>
</html>
