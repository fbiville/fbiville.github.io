<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Neo4j et graphe social</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="//fbiville.github.io/themes/Casper/favicon.ico">

    <link rel="stylesheet" type="text/css" href="//fbiville.github.io/themes/Casper/assets/css/screen.css?v=1.0.0" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />

    <link rel="canonical" href="https://fbiville.github.io/2013/10/27/Neo4j-et-graphe-social.html" />
    
    <meta property="og:site_name" content="(10 piece) Puzzler" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Neo4j et graphe social" />
    <meta property="og:description" content="Recommandations de collègues Rappel de l&#x27;épisode précédent L’exercice posé en fin d’article précédent, dans le cadre d’un moteur de recommandations pour un réseau social professionnel, était le suivant : “trouve-moi tous les contacts de mes contacts, qui connaissent..." />
    <meta property="og:url" content="https://fbiville.github.io/2013/10/27/Neo4j-et-graphe-social.html" />
    <meta property="article:published_time" content="2013-10-26T22:00:00.000Z" />
    <meta property="article:modified_time" content="2015-05-09T12:14:49.312Z" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Neo4j et graphe social" />
    <meta name="twitter:description" content="Recommandations de collègues Rappel de l&#x27;épisode précédent L’exercice posé en fin d’article précédent, dans le cadre d’un moteur de recommandations pour un réseau social professionnel, était le suivant : “trouve-moi tous les contacts de mes contacts, qui connaissent..." />
    <meta name="twitter:url" content="https://fbiville.github.io/2013/10/27/Neo4j-et-graphe-social.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "(10 piece) Puzzler",
    "author": {
        "@type": "Person",
        "name": "@fbiville",
        "image": "https://avatars.githubusercontent.com/u/445792?v=3",
        "url": "undefined/author/undefined",
        "sameAs": "http://florent.biville.net"
    },
    "headline": "Neo4j et graphe social",
    "url": "https://fbiville.github.io/2013/10/27/Neo4j-et-graphe-social.html",
    "datePublished": "2013-10-26T22:00:00.000Z",
    "dateModified": "2015-05-09T12:14:49.312Z",
    "description": "Recommandations de collègues Rappel de l&#x27;épisode précédent L’exercice posé en fin d’article précédent, dans le cadre d’un moteur de recommandations pour un réseau social professionnel, était le suivant : “trouve-moi tous les contacts de mes contacts, qui connaissent..."
}
    </script>

    <meta name="generator" content="Ghost ?" />
    <link rel="alternate" type="application/rss+xml" title="(10 piece) Puzzler" href="https://fbiville.github.io/rss" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">
</head>
<body class="post-template">

    


<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        <a class="back-button icon-arrow-left" href="https://fbiville.github.io">Home</a>
        <!-- <a class="subscribe-button icon-feed" href="https://fbiville.github.io/rss/">Subscribe</a> -->
    </nav>
</header>

<main class="content" role="main">

    <article class="post">

        <header class="post-header">
            <h1 class="post-title">Neo4j et graphe social</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2013-10-27">27 October 2013</time> 
            </section>
        </header>

        <section class="post-content">
            <div class="sect1">
<h2 id="_recommandations_de_coll_gues">Recommandations de collègues</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_rappel_de_l_pisode_pr_c_dent">Rappel de l'épisode précédent</h3>
<div class="paragraph">
<p>L’exercice posé en fin d’article précédent, dans le cadre d’un moteur de
recommandations pour un réseau social professionnel, était le suivant :</p>
</div>
<div class="paragraph">
<p><em>“trouve-moi tous les contacts de mes contacts, qui connaissent (sont en
contact avec) quelqu’un avec qui j’ai déjà travaillé (avec qui je ne
suis pas déjà en contact)”</em></p>
</div>
<div class="paragraph">
<p>Petit rappel du graphe :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>les utilisateurs auront un label CONTACT</p>
</li>
<li>
<p>les entreprises auront un label COMPANY</p>
</li>
<li>
<p>les noeuds ont (pour simplifier) une propriété name qui contient nom
et prénom</p>
</li>
<li>
<p>le fait d’être en contact est matérialisé par</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>(:CONTACT)-[:IN_CONTACT_WITH]-(:CONTACT)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>le fait de travailler pour une entreprise s’écrit :</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>(:CONTACT)-[:WORKED_IN]&#8594;(:COMPANY)</p>
</div>
<div class="paragraph">
<p>Envisageons le problème avec humilité, et tâchons de le résoudre bloc
par bloc.</p>
</div>
</div>
<div class="sect2">
<h3 id="_anciens_coll_gues">Anciens collègues</h3>
<div class="paragraph">
<p>Trouvons donc mes anciens collègues :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cypher" data-lang="cypher">MATCH (me:CONTACT)-[:WORKED_IN]-&gt;(:COMPANY)&lt;-[:WORKED_IN]-(colleagues:CONTACT)
WHERE me.name = {name}
RETURN me, colleagues</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pas mal, mais je voudrais éviter d’inclure ceux avec qui je suis déjà en
contact.</p>
</div>
<div class="paragraph">
<p>Pour se faire, il suffit de vérifier l’absence de la relation entre les
collègues et moi :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cypher" data-lang="cypher">MATCH (me:CONTACT)-[:WORKED_IN]-&gt;(:COMPANY)&lt;-[:WORKED_IN]-(colleagues:CONTACT)
WHERE me.name = {name} AND NOT (me-[:IN_CONTACT_WITH]-colleagues)
RETURN me, colleagues</code></pre>
</div>
</div>
<div class="paragraph">
<p>Allons encore plus loin : vous ne souhaitez maintenant en résultat que
les collègues qui ont travaillé dans l’entreprise en même temps que
vous. En d’autres termes, les personnes qui ont terminé (voire pas
terminé) leur contrat après vos débuts et qui ont commencé avant que
vous partiez (pour peu que vous soyez parti).</p>
</div>
<div class="paragraph">
<p>Ici, les spécifications ne sont pas complètes, vous retournez donc vers
les autorités compétentes et en concluez que cette notion de date est
portée par la relation WORKED_IN, avec deux attributs de type timestamp
: beginning et end (end est optionnel si le collègue y travaille
toujours). Pratique d’avoir des propriétés sur les relations, non ?</p>
</div>
<div class="paragraph">
<p>Maintenant, les deux relations WORKED_IN nous intéressent puisqu’elles
représentent respectivement vos dates de présence et les dates de
présence de vos collègues dans les entreprises communes. Profitons-en,
d’ailleurs, pour séparer le MATCH en deux sous-patterns, afin
d’améliorer la lisibilité de la requête.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cypher" data-lang="cypher">MATCH (me:CONTACT)-[myStay:WORKED_IN]-&gt;(company:COMPANY),
company&lt;-[theirStay:WORKED_IN]-(colleagues:CONTACT)
WHERE me.name = {name} AND NOT (me-[:IN_CONTACT_WITH]-colleagues)
RETURN me, colleagues</code></pre>
</div>
</div>
<div class="paragraph">
<p>Exprimons maintenant les contraintes de chevauchement :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cypher" data-lang="cypher">MATCH (me:CONTACT)-[myStay:WORKED_IN]-&gt;(company:COMPANY),
company&lt;-[theirStay:WORKED_IN]-(colleagues:CONTACT)
WHERE me.name = {name} AND NOT (me-[:IN_CONTACT_WITH]-colleagues)
AND myStay.beginning &lt; theirStay.end
AND theirStay.beginning &lt; myStay.end
RETURN me, colleagues</code></pre>
</div>
</div>
<div class="paragraph">
<p>… sans oublier le fait que les personnes peuvent encore être présentes
dans l’entreprise (auquel cas la propriété end ne sera tout simplement
pas renseignée).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cypher" data-lang="cypher">MATCH (me:CONTACT)-[myStay:WORKED_IN]-&gt;(company:COMPANY),
company&lt;-[theirStay:WORKED_IN]-(colleagues:CONTACT)
WHERE me.name = {name} AND NOT (me-[:IN_CONTACT_WITH]-colleagues)
AND (NOT HAS(theirStay.end) OR myStay.beginning &lt; theirStay.end)
AND (NOT HAS(myStay.end) OR theirStay.beginning &lt; myStay.end)
RETURN me, colleagues</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_filtrage_des_coll_gues_par_contact">Filtrage des collègues par contact</h3>
<div class="paragraph">
<p>Maintenant que avons sous la main une requête de taille déjà
relativement importante, deux stratégies se présentent pour continuer :</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>nous continuons à l’enrichir au risque de la rendre complètement spécifique et potentiellement illisible</p>
</li>
<li>
<p>nous la chaînons avec une autre-requête</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Vous l’aurez compris, nous allons privilégier la seconde piste. De plus,
cela va nous permettre d’introduire la clause WITH, qui agit à l’instar
d’un “pipe” qui sert de glue entre différentes commandes sous Unix.</p>
</div>
<div class="paragraph">
<p>Deux éléments nous intéressent dans la requête précédente, ceux qui sont
spécifiés dans la clause RETURN. Afin de pouvoir les réutiliser dans la
requête suivante, nous allons simplement remplacer RETURN par WITH et
filtrer par collègues :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cypher" data-lang="cypher">MATCH (me:CONTACT)-[myStay:WORKED_IN]-&gt;(company:COMPANY),
company&lt;-[theirStay:WORKED_IN]-(colleagues:CONTACT)
WHERE me.name = {name} AND NOT (me-[:IN_CONTACT_WITH]-colleagues)
AND (NOT HAS(theirStay.end) OR myStay.beginning &lt; theirStay.end)
AND (NOT HAS(myStay.end) OR theirStay.beginning &lt; myStay.end)
WITH me, colleagues
WHERE (me-[:IN_CONTACT_WITH]-(:CONTACT)-[:IN_CONTACT_WITH]-colleagues)
RETURN me, colleagues</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sympa, non ?</p>
</div>
<div class="paragraph">
<p>Allez, une dernière pour la route : pour que de retourner n associations 1-1 comme c’est le cas actuellement, les autorités compétentes m’ont demandé de directement retourner une association 1-n avec les collègues triés par nom. Autrement dit : retourner la collection agrégée de collègues.</p>
</div>
<div class="paragraph">
<p>Petite subtilité : rien ne vous garantit l’ordre des collègues qui vous a été retourné. Nous pouvons utiliser la clause ORDER BY juste après WITH, afin de s’assurer que les collègues sont triés (l’opération de filtrage qui suit n’y changera rien).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cypher" data-lang="cypher">MATCH (me:CONTACT)-[myStay:WORKED_IN]-&gt;(company:COMPANY),
company&lt;-[theirStay:WORKED_IN]-(colleagues:CONTACT)
WHERE me.name = {name} AND NOT (me-[:IN_CONTACT_WITH]-colleagues)
AND (NOT HAS(theirStay.end) OR myStay.beginning &lt; theirStay.end)
AND (NOT HAS(myStay.end) OR theirStay.beginning &lt; myStay.end)
WITH me, colleagues
ORDER BY colleagues.name
WHERE (me-[:IN_CONTACT_WITH]-(:CONTACT)-[:IN_CONTACT_WITH]-colleagues)
RETURN me, colleagues</code></pre>
</div>
</div>
<div class="paragraph">
<p>Reste maintenant à agréger :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-cypher" data-lang="cypher">MATCH (me:CONTACT)-[myStay:WORKED_IN]-&gt;(company:COMPANY),
company&lt;-[theirStay:WORKED_IN]-(colleagues:CONTACT)
WHERE me.name = {name} AND NOT (me-[:IN_CONTACT_WITH]-colleagues)
AND (NOT HAS(theirStay.end) OR myStay.beginning &lt; theirStay.end)
AND (NOT HAS(myStay.end) OR theirStay.beginning &lt; myStay.end)
WITH me, colleagues
ORDER BY colleagues.name
WHERE (me-[:IN_CONTACT_WITH]-(:CONTACT)-[:IN_CONTACT_WITH]-colleagues)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Et le tour est joué !</p>
</div>
<div class="paragraph">
<p>Les avantages d’avoir découpé la requête comme suit sont multiples :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>la requête, découpée en blocs distincts, est nettement plus lisible</p>
</li>
<li>
<p>elle est également plus maintenable puisque chaque bloc se voit confier une partie bien identifiée du problème à résoudre</p>
</li>
<li>
<p>et surtout, puisque l’on retourne toujours le contact concerné et ses suggestions de contact, je peux me permettre d’opérer à la “fire and forget” puisque le résultat de la requête contient tout le contexte nécessaire à son interprétation</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_le_mot_de_la_fin">Le mot de la fin</h3>
<div class="paragraph">
<p>Et dire que Cypher a démarré comme une idée de time-off. Il y a 1.5 ans
(version Neo4J 1.4 ou 1.5), seules des requêtes assez limitées et en
lecture étaient possibles. Ce langage ne cesse de m’enthousiasmer : il
reste vraiment accessible aux néophytes et son éventail d’opérations
possibles va bientôt faire de lui un langage Turing-Complete :-)</p>
</div>
<div class="paragraph">
<p>Qu’on se le dise, Cypher va devenir la voie privilégiée pour requêter de
la donnée sur Neo4j. Cela est somme toute logique, on attend d’une base
de données qu’elle offre un langage de requêtage.</p>
</div>
<div class="paragraph">
<p>Reste peut-être un dernier chaînon pour compléter le tableau presque
parfait : un protocole d’échange avec moins d’overhead que l’API REST
standard pour communiquer avec une instance Neo4j distante, comme le
déplorait <a href="https://twitter.com/sdeleuze">Sébastien Deleuze</a> lors d&#8217;un
échange à Soft-Shake.</p>
</div>
<div class="paragraph">
<p>Le prochain article aura pour thème : Neo4J sous le capot.</p>
</div>
</div>
<div class="sect2">
<h3 id="_post_scriptum_un_jeu_de_donn_es_pour_v_rifier_la_requ_te">Post-Scriptum : un jeu de données pour vérifier la requête</h3>
<div class="paragraph">
<p>Essayez donc la requête finale sur <a href="http://console.neo4j.org" class="bare">http://console.neo4j.org</a> et les
requêtes intermédiaires en remplaçant <code>{name}</code> par ‘Florent’ sur le jeu
de données fourni ci-dessous.</p>
</div>
</div>
</div>
</div>
        </section>

        <footer class="post-footer">


            <figure class="author-image">
                <a class="img" href="" style="background-image: url(https://avatars.githubusercontent.com/u/445792?v=3)"><span class="hidden">@fbiville's Picture</span></a>
            </figure>

            <section class="author">
                <h4><a href="">@fbiville</a></h4>

                    <p>Read <a href="">more posts</a> by this author.</p>
                <div class="author-meta">
                    <span class="author-location icon-location">Paris, France</span>
                    <span class="author-link icon-link"><a href="http://florent.biville.net">http://florent.biville.net</a></span>
                </div>
            </section>


            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://twitter.com/share?text=Neo4j%20et%20graphe%20social&amp;url=https://fbiville.github.io/2013/10/27/Neo4j-et-graphe-social.html"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https://fbiville.github.io/2013/10/27/Neo4j-et-graphe-social.html"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=https://fbiville.github.io/2013/10/27/Neo4j-et-graphe-social.html"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

        </footer>


        <section class="post-comments">
          <div id="disqus_thread"></div>
          <script type="text/javascript">
          var disqus_shortname = 'fbiville-github-io'; // required: replace example with your forum shortname
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </section>


    </article>

</main>



    <footer class="site-footer clearfix">
        <section class="copyright"><a href="https://fbiville.github.io">(10 piece) Puzzler</a> &copy; 2015</section>
        <section class="poweredby">Proudly published with <a href="http://hubpress.io">HubPress</a></section>
    </footer>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();      
      </script>

    <script type="text/javascript" src="//fbiville.github.io/themes/Casper/assets/js/jquery.fitvids.js?v=1.0.0"></script>
    <script type="text/javascript" src="//fbiville.github.io/themes/Casper/assets/js/index.js?v=1.0.0"></script>

</body>
</html>
